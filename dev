#!/bin/bash

# 获取脚本所在目录（项目根目录）
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="${SCRIPT_DIR}/backend"
FRONTEND_DIR="${SCRIPT_DIR}/frontend"
BUILD_DIR="${SCRIPT_DIR}/build"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 打印带颜色的消息
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# 启动开发环境
start_dev() {
    print_info "启动开发环境..."
    
    # 检查目录是否存在
    if [ ! -d "$BACKEND_DIR" ]; then
        print_error "后端目录不存在: $BACKEND_DIR"
        exit 1
    fi
    
    if [ ! -d "$FRONTEND_DIR" ]; then
        print_error "前端目录不存在: $FRONTEND_DIR"
        exit 1
    fi
    
    # 启动后端（后台运行，保留输出）
    print_info "启动后端服务..."
    cd "$BACKEND_DIR" || exit 1
    make dev &
    BACKEND_PID=$!
    echo $BACKEND_PID > /tmp/nest-starter-backend.pid
    
    # 等待一下确保后端启动
    sleep 2
    
    # 启动前端（后台运行，保留输出）
    print_info "启动前端服务..."
    cd "$FRONTEND_DIR" || exit 1
    pnpm dev &
    FRONTEND_PID=$!
    echo $FRONTEND_PID > /tmp/nest-starter-frontend.pid
    
    print_info "后端进程 ID: $BACKEND_PID"
    print_info "前端进程 ID: $FRONTEND_PID"
    print_info "开发环境已启动，日志将显示在下方"
    print_info "按 Ctrl+C 可停止所有服务"
    
    # 清理函数
    cleanup() {
        print_info "正在停止服务..."
        kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
        # 确保进程组也被终止
        pkill -P $BACKEND_PID 2>/dev/null
        pkill -P $FRONTEND_PID 2>/dev/null
        rm -f /tmp/nest-starter-backend.pid /tmp/nest-starter-frontend.pid
        print_info "服务已停止"
        exit 0
    }
    
    # 设置信号处理
    trap cleanup INT TERM
    
    # 等待所有后台进程
    wait
}

# 打包应用
build_app() {
    print_info "开始打包应用..."
    
    # 检查目录是否存在
    if [ ! -d "$BACKEND_DIR" ]; then
        print_error "后端目录不存在: $BACKEND_DIR"
        exit 1
    fi
    
    if [ ! -d "$FRONTEND_DIR" ]; then
        print_error "前端目录不存在: $FRONTEND_DIR"
        exit 1
    fi
    
    # 清理旧的构建目录
    if [ -d "$BUILD_DIR" ]; then
        print_info "清理旧的构建目录..."
        rm -rf "$BUILD_DIR"
    fi
    
    # 构建后端
    print_info "构建后端..."
    cd "$BACKEND_DIR" || exit 1
    if ! pnpm build; then
        print_error "后端构建失败"
        exit 1
    fi
    
    # 构建前端
    print_info "构建前端..."
    cd "$FRONTEND_DIR" || exit 1
    if ! pnpm build; then
        print_error "前端构建失败"
        exit 1
    fi
    
    # 创建构建目录
    mkdir -p "${BUILD_DIR}/backend"
    mkdir -p "${BUILD_DIR}/frontend"
    
    # 移动后端文件
    print_info "整理后端构建文件..."
    if [ -d "${BACKEND_DIR}/dist" ]; then
        cp -r "${BACKEND_DIR}/dist"/* "${BUILD_DIR}/backend/"
        print_info "已复制后端 dist 到 build/backend"
    else
        print_warn "后端 dist 目录不存在，跳过"
    fi
    if [ -d "${BACKEND_DIR}/prisma" ]; then
        cp -r "${BACKEND_DIR}/prisma" "${BUILD_DIR}/backend/"
        print_info "已复制后端 prisma 到 build/backend"
    else
        print_warn "后端 prisma 目录不存在，跳过"
    fi
    
    # 移动前端文件
    print_info "整理前端构建文件..."
    if [ -d "${FRONTEND_DIR}/dist" ]; then
        cp -r "${FRONTEND_DIR}/dist"/* "${BUILD_DIR}/frontend/"
        print_info "已复制前端 dist 内容到 build/frontend"
    else
        print_error "前端 dist 目录不存在"
        exit 1
    fi
    
    print_info "打包完成！构建文件位于: $BUILD_DIR"
}

# 主函数
main() {
    case "$1" in
        dev|start)
            start_dev
            ;;
        build)
            build_app
            ;;
        *)
            echo "用法: $0 {dev|start|build}"
            echo ""
            echo "命令说明:"
            echo "  dev, start  - 启动开发环境（后端: make dev, 前端: pnpm dev）"
            echo "  build       - 打包应用并整理文件到 build 目录"
            exit 1
            ;;
    esac
}

# 执行主函数
main "$@"

