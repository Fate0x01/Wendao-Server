# PRD: 商品管理模块 (Goods Module)

## 1. Introduction/Overview

商品管理模块是仓储服务系统的核心功能之一，用于管理商品信息、额外成本和变动日志。该模块提供完整的商品 CRUD 操作，支持商品信息的全字段查询、修改和删除，同时记录所有变更操作到变动日志中，确保数据可追溯性。

**目标**：为系统提供完整的商品管理功能，包括商品信息维护、额外成本管理和操作日志追踪。

## 2. Goals

1. 提供商品信息的完整查询、修改和删除功能
2. 支持商品变动日志的查询和追踪
3. 支持为商品添加额外成本记录
4. 确保所有变更操作都记录到变动日志中
5. 提供灵活的筛选和分页功能

## 3. User Stories

1. **作为仓库管理员**，我希望能够查询商品列表，以便了解所有商品信息
2. **作为仓库管理员**，我希望能够根据部门、店铺名称、SKU 等条件筛选商品，以便快速找到目标商品
3. **作为仓库管理员**，我希望能够修改商品信息，以便更新商品的各种属性
4. **作为仓库管理员**，我希望能够删除商品，以便清理无效数据
5. **作为仓库管理员**，我希望能够查看商品的变动日志，以便追踪商品的历史变更
6. **作为仓库管理员**，我希望能够为商品添加额外成本，以便记录额外的费用支出
7. **作为系统审计员**，我希望所有商品变更操作都有日志记录，以便进行审计追踪

## 4. Functional Requirements

### 4.1 查询商品列表

1. **FR-1.1**: 系统必须提供分页查询商品列表的接口
2. **FR-1.2**: 查询接口必须支持以下筛选条件：
   - 部门ID (departmentId)
   - 店铺名称关键词 (shopName)
   - SKU 关键词（在 sku JSON 字段中搜索）
   - 货架号 (shelfNumber)
   - 入仓条码 (inboundBarcode)
3. **FR-1.3**: 查询结果必须返回商品的所有字段（全字段）
4. **FR-1.4**: 查询结果必须包含关联的额外成本列表 (extraCosts)
5. **FR-1.5**: 查询结果必须按创建时间倒序排列

### 4.2 修改商品

1. **FR-2.1**: 系统必须提供修改商品信息的接口
2. **FR-2.2**: 修改接口必须支持修改商品的所有字段
3. **FR-2.3**: 修改前必须校验商品是否存在
4. **FR-2.4**: 修改操作必须进行权限校验（CASL）
5. **FR-2.5**: 修改操作必须创建变动日志，仅记录变更或新增的字段
6. **FR-2.6**: 变动日志必须包含操作人信息（userId, username）
7. **FR-2.7**: 如果修改了 departmentId，必须同步更新 departmentName 冗余字段

### 4.3 删除商品

1. **FR-3.1**: 系统必须提供删除商品的接口
2. **FR-3.2**: 删除操作必须进行物理删除（从数据库删除）
3. **FR-3.3**: 删除前必须校验商品是否存在
4. **FR-3.4**: 删除操作必须进行权限校验（CASL）
5. **FR-3.5**: 删除操作必须创建变动日志，日志内容包含相关 SKU 信息
6. **FR-3.6**: 删除商品时，关联的额外成本（ExtraCost）和变动日志（GoodChangeLog）必须级联删除

### 4.4 查询商品变动日志列表

1. **FR-4.1**: 系统必须提供分页查询商品变动日志列表的接口
2. **FR-4.2**: 查询接口必须支持以下筛选条件：
   - 商品ID (goodId)
   - 操作人ID (userId)
   - 操作人用户名关键词 (username)
   - 时间范围（开始时间、结束时间）
3. **FR-4.3**: 查询结果必须返回变动日志的所有字段
4. **FR-4.4**: 查询结果必须包含关联的商品信息（good）
5. **FR-4.5**: 查询结果必须按创建时间倒序排列

### 4.5 添加指定商品额外成本

1. **FR-5.1**: 系统必须提供为商品添加额外成本的接口
2. **FR-5.2**: 添加前必须校验商品是否存在
3. **FR-5.3**: 额外成本必须包含金额（amount）和描述（description）
4. **FR-5.4**: 添加额外成本操作必须创建变动日志
5. **FR-5.5**: 变动日志内容格式为："添加额外成本：{amount}元，描述：{description}"

## 5. Non-Goals (Out of Scope)

1. 商品创建功能（不在本次开发范围内）
2. 商品批量操作功能
3. 商品导入/导出功能
4. 商品图片上传功能（仅支持 URL）
5. 商品统计和分析功能
6. 额外成本的修改和删除功能

## 6. Design Considerations

### 6.1 API 设计

- 遵循 RESTful 风格，使用 POST 请求进行查询和更新操作
- 使用统一的响应格式（ResultData）
- 所有接口必须包含 Swagger 文档注解

### 6.2 权限控制

- 所有接口必须使用 @Permission 装饰器标注权限
- 使用 CASL 进行细粒度权限控制
- 权限组统一为"商品管理"

### 6.3 数据校验

- 使用 class-validator 进行 DTO 校验
- 所有必填字段必须标注 @ApiProperty
- 所有可选字段必须标注 @ApiPropertyOptional 和 @IsOptional

### 6.4 变动日志记录

- 修改商品时，需要对比新旧值，仅记录变更的字段
- 删除商品时，需要从商品信息中提取 SKU 信息记录到日志
- 所有日志必须包含操作人信息（从 ClsService 获取）

## 7. Technical Considerations

### 7.1 技术栈

- NestJS 框架
- Prisma ORM
- CASL 权限控制
- class-validator 数据校验
- Swagger API 文档

### 7.2 模块结构

```
sys_goods/
  ├── dto/
  │   ├── goods-query.dto.ts          # 商品查询 DTO
  │   ├── update-goods.dto.ts          # 更新商品 DTO
  │   ├── goods-id.dto.ts              # 商品ID DTO
  │   ├── change-log-query.dto.ts      # 变动日志查询 DTO
  │   └── add-extra-cost.dto.ts        # 添加额外成本 DTO
  ├── entities/
  │   ├── goods.entity.ts              # 商品实体
  │   ├── extra-cost.entity.ts         # 额外成本实体
  │   └── change-log.entity.ts         # 变动日志实体
  ├── sys_goods.controller.ts          # 商品控制器
  ├── sys_goods.service.ts             # 商品服务
  └── sys_goods.module.ts              # 商品模块
```

### 7.3 数据库关系

- Goods 与 Department 多对一关系
- Goods 与 ExtraCost 一对多关系
- Goods 与 GoodChangeLog 一对多关系
- GoodChangeLog 与 User 多对一关系（可选）

### 7.4 依赖模块

- SharedModule（提供 PrismaService、ClsService）
- 需要访问 Department 和 User 模型进行关联查询

## 8. Success Metrics

1. 所有接口功能正常，能够正确执行 CRUD 操作
2. 变动日志能够正确记录所有变更操作
3. 权限控制正常工作，未授权用户无法操作
4. 数据校验有效，无效数据无法提交
5. API 文档完整，所有接口都有清晰的说明

## 9. Open Questions

1. 商品删除时，是否需要检查是否有其他关联数据（如订单、库存等）？
2. 变动日志的 content 字段是否需要支持结构化数据（JSON）？
3. 商品查询时，是否需要支持按价格范围筛选？
4. 额外成本的金额是否需要支持负数（退款场景）？

