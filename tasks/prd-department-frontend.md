# PRD: 前端部门管理模块

## 1. 概述

基于树状分权模型，实现前端部门管理模块，包含**部门管理**和**成员管理**两个页面。采用左侧部门树 + 右侧详情/列表的布局模式，充分利用 CrudKit 组件库和树形结构优势，提供直观的组织架构管理体验。

---

## 2. 目标

1. 实现左侧部门树 + 右侧内容区的双栏布局
2. 支持部门的增删改查操作（通过工具栏和操作列）
3. 实现部门详情展示（基础信息、负责人、成员数量）
4. 支持成员管理（创建新用户、从已有成员中添加）
5. 实现基于角色的前端权限控制（按钮显隐）
6. 部门禁用状态可视化（灰色展示）
7. 提供独立的成员管理页面作为补充入口

---

## 3. 用户故事

### 超级管理员

- 作为超管，我可以在部门树中看到所有部门的完整结构
- 作为超管，我可以创建一级部门
- 作为超管，我可以为任意部门添加成员或设置负责人
- 作为超管，我可以禁用/启用任意部门

### 一级部门管理员

- 作为一级部门管理员，我只能看到本部门及其子部门
- 作为一级部门管理员，我可以在本部门下创建二级部门
- 作为一级部门管理员，我可以为二级部门添加成员
- 作为一级部门管理员，我无法创建一级部门（按钮隐藏）

### 二级部门负责人

- 作为二级部门负责人，我只能看到本部门
- 作为二级部门负责人，我可以在本部门下添加普通成员
- 作为二级部门负责人，我无法创建任何部门（按钮隐藏）

### 普通成员

- 作为普通成员，我只能查看本部门的基本信息
- 作为普通成员，我无法进行任何管理操作

---

## 4. 功能需求

### 4.1 页面结构

#### 部门管理页面（/department/list）

```
┌──────────────────────────────────────────────────────────────┐
│ 部门列表                                                      │
├─────────────────┬────────────────────────────────────────────┤
│                 │ [工具栏] [新建部门] [刷新]                   │
│   部门树        ├────────────────────────────────────────────┤
│                 │                                            │
│   ▼ 华东分公司  │  部门详情 / 成员列表                        │
│     ├ 销售一部  │                                            │
│     └ 销售二部  │  - 部门名称、描述、状态                     │
│   ▼ 华北分公司  │  - 负责人列表                              │
│     └ 运营部    │  - 成员数量                                │
│                 │  - [查看成员] [编辑] [删除]                 │
│   [搜索框]      │                                            │
└─────────────────┴────────────────────────────────────────────┘
```

#### 成员管理页面（/department/members）

```
┌──────────────────────────────────────────────────────────────┐
│ 成员管理                                                      │
├─────────────────┬────────────────────────────────────────────┤
│                 │ [搜索栏] 关键词 | 部门筛选                   │
│   部门树        ├────────────────────────────────────────────┤
│   （筛选器）    │ [工具栏] [添加成员] [刷新]                   │
│                 ├────────────────────────────────────────────┤
│   ▼ 华东分公司  │                                            │
│     ├ 销售一部  │  成员列表表格                               │
│     └ 销售二部  │  - 用户名 | 状态 | 是否负责人 | 操作        │
│                 │                                            │
└─────────────────┴────────────────────────────────────────────┘
```

### 4.2 部门树组件

| 序号 | 功能           | 说明                                           |
| ---- | -------------- | ---------------------------------------------- |
| 1    | 树形展示       | 支持两级部门结构展示（一级部门→二级部门）      |
| 2    | 节点选中       | 点击节点选中，右侧展示对应部门详情             |
| 3    | 禁用状态可视化 | 禁用的部门节点显示为灰色，并添加"已禁用"标识   |
| 4    | 搜索过滤       | 支持按部门名称搜索过滤树节点                   |
| 5    | 展开/收起      | 支持全部展开、全部收起操作                     |
| 6    | 默认选中       | 进入页面时默认选中第一个部门（如有权限）       |

### 4.3 部门管理功能

| 序号 | 功能     | 说明                                               |
| ---- | -------- | -------------------------------------------------- |
| 1    | 部门列表 | 通过部门树展示，支持搜索过滤                       |
| 2    | 部门详情 | 选中部门后在右侧展示详情面板                       |
| 3    | 创建部门 | 工具栏"新建部门"按钮，弹窗表单                     |
| 4    | 编辑部门 | 操作列"编辑"按钮，弹窗表单                         |
| 5    | 删除部门 | 操作列"删除"按钮，二次确认                         |
| 6    | 禁用部门 | 编辑时可切换禁用状态                               |

#### 部门详情面板内容

| 字段       | 说明                           |
| ---------- | ------------------------------ |
| 部门名称   | 显示部门名称                   |
| 部门描述   | 显示部门描述（可选）           |
| 部门状态   | 正常/禁用（Tag 展示）          |
| 父级部门   | 显示父部门名称（一级部门显示"-"） |
| 负责人     | 显示负责人列表（头像+用户名）  |
| 成员数量   | 显示部门成员总数               |
| 创建时间   | 显示部门创建时间               |
| 操作按钮   | [查看成员] [编辑] [删除]       |

#### 创建/编辑部门表单

| 字段     | 类型       | 必填 | 说明                                     |
| -------- | ---------- | ---- | ---------------------------------------- |
| 部门名称 | Input      | 是   | 2-32 字符                                |
| 部门描述 | Textarea   | 否   | 部门描述信息                             |
| 父级部门 | TreeSelect | 否   | 创建二级部门时必选；创建一级部门时禁用   |
| 是否禁用 | Switch     | 否   | 默认为"正常"                             |

### 4.4 成员管理功能

| 序号 | 功能         | 说明                                         |
| ---- | ------------ | -------------------------------------------- |
| 1    | 成员列表     | 分页表格展示部门成员                         |
| 2    | 成员搜索     | 支持按用户名关键词搜索                       |
| 3    | 添加新成员   | 创建新用户账号并关联到当前部门               |
| 4    | 添加已有成员 | 从当前用户管辖范围内的已有成员中选择添加     |
| 5    | 移除成员     | 从部门中移除成员（不删除用户账号）           |
| 6    | 设置负责人   | 将成员设置为部门负责人                       |
| 7    | 取消负责人   | 取消成员的负责人身份                         |

#### 成员列表表格列

| 列名       | 说明                             |
| ---------- | -------------------------------- |
| 用户名     | 成员用户名                       |
| 状态       | 正常/禁用（Tag）                 |
| 是否负责人 | 是/否（Tag，负责人高亮显示）     |
| 创建时间   | 用户创建时间                     |
| 操作       | [设为负责人/取消负责人] [移除]   |

#### 添加新成员弹窗

| 字段       | 类型   | 必填 | 说明                         |
| ---------- | ------ | ---- | ---------------------------- |
| 用户名     | Input  | 是   | 2-16 字符                    |
| 密码       | Input  | 是   | 6-16 字符                    |
| 是否负责人 | Switch | 否   | 默认为否                     |

#### 添加已有成员弹窗

| 字段     | 类型   | 必填 | 说明                               |
| -------- | ------ | ---- | ---------------------------------- |
| 选择成员 | Select | 是   | 下拉选择（支持多选、搜索）         |

### 4.5 权限控制

基于用户角色（`BaseRole`）在前端进行按钮显隐控制：

| 功能           | SUPER_ADMIN | DEPARTMENT_LEADER（一级） | DEPARTMENT_LEADER（二级） | DEPARTMENT_MEMBER |
| -------------- | ----------- | ------------------------- | ------------------------- | ----------------- |
| 查看部门树     | 全部        | 本部门及子部门            | 本部门                    | 本部门            |
| 创建一级部门   | ✓           | ✗                         | ✗                         | ✗                 |
| 创建二级部门   | ✓           | ✓（本部门下）             | ✗                         | ✗                 |
| 编辑部门       | ✓           | ✓（本部门及子部门）       | ✗                         | ✗                 |
| 删除部门       | ✓           | ✓（子部门）               | ✗                         | ✗                 |
| 添加成员       | ✓           | ✓（子部门）               | ✓（本部门）               | ✗                 |
| 移除成员       | ✓           | ✓（子部门）               | ✓（本部门）               | ✗                 |
| 设置负责人     | ✓           | ✓（子部门）               | ✗                         | ✗                 |

---

## 5. 非目标（不在范围内）

1. 不支持拖拽调整部门层级
2. 不支持批量操作（批量移除成员、批量设置负责人）
3. 不支持成员导出功能
4. 不支持部门合并/拆分
5. 不支持跨部门调动成员

---

## 6. 设计考量

### 6.1 布局设计

- 采用 Flexbox 双栏布局，左侧树宽度固定（240px），支持拖拽调整
- 右侧内容区自适应宽度
- 响应式设计：小屏幕下左侧树可收起为抽屉模式

### 6.2 交互设计

- 部门树节点悬停显示完整名称（Tooltip）
- 禁用部门显示为灰色半透明样式
- 表格操作采用 Link 按钮风格，危险操作（删除/移除）使用红色
- 所有删除/移除操作需二次确认

### 6.3 状态展示

```
正常状态: <Tag theme="success">正常</Tag>
禁用状态: <Tag theme="danger">禁用</Tag>
负责人标识: <Tag theme="primary">负责人</Tag>
```

---

## 7. 技术考量

### 7.1 目录结构

```
frontend/src/pages/Department/          # 部门管理板块（独立一级菜单）
├── DepartmentManager/                  # 部门列表页面
│   ├── index.tsx                       # 页面主入口
│   ├── index.module.less               # 页面样式
│   ├── components/
│   │   ├── DeptTree.tsx                # 部门树组件
│   │   ├── DeptDetail.tsx              # 部门详情面板
│   │   ├── DeptFormModal.tsx           # 创建/编辑部门弹窗
│   │   └── MemberList.tsx              # 成员列表组件（嵌入详情使用）
│   └── hooks/
│       └── useDeptTree.ts              # 部门树数据管理 Hook
├── MemberManager/                      # 成员管理页面
│   ├── index.tsx                       # 页面主入口
│   ├── index.module.less               # 页面样式
│   └── components/
│       ├── AddMemberModal.tsx          # 添加新成员弹窗
│       └── SelectMemberModal.tsx       # 选择已有成员弹窗
```

### 7.2 路由配置

部门管理作为独立的一级菜单板块，与系统管理平级：

```typescript
// router/index.ts
const routes: IRouter[] = [
  // ... 其他路由
  {
    path: '/department',
    meta: {
      title: '部门管理',
      Icon: UserGroupIcon,
      allowRole: ['SUPER_ADMIN', 'DEPARTMENT_LEADER', 'DEPARTMENT_MEMBER'],
    },
    children: [
      {
        path: 'list',
        Component: lazy(() => import('pages/Department/DepartmentManager')),
        meta: { title: '部门列表' },
      },
      {
        path: 'members',
        Component: lazy(() => import('pages/Department/MemberManager')),
        meta: { title: '成员管理' },
      },
    ],
  },
  {
    path: '/system',
    meta: {
      title: '系统管理',
      Icon: SettingIcon,
      allowRole: ['SUPER_ADMIN'], // 仅超管可见
    },
    children: [
      // 用户管理、角色管理等
    ],
  },
];
```

### 7.3 API 使用

已有 API（无需新增）：

| API                              | 用途               |
| -------------------------------- | ------------------ |
| `sysDeptControllerGetDeptTree`   | 获取部门树         |
| `sysDeptControllerGetDeptList`   | 获取部门列表       |
| `sysDeptControllerGetDept`       | 获取部门详情       |
| `sysDeptControllerCreateDept`    | 创建部门           |
| `sysDeptControllerUpdateDept`    | 更新部门           |
| `sysDeptControllerDeleteDept`    | 删除部门           |
| `sysDeptControllerGetDeptMembers`| 获取部门成员列表   |
| `sysDeptControllerAddMember`     | 添加成员（创建用户）|
| `sysDeptControllerRemoveMember`  | 移除成员           |
| `sysDeptControllerSetLeaders`    | 设置负责人         |

### 7.4 组件复用

- 使用 CrudKit 的 `useCrudTable` 管理成员列表状态
- 使用 CrudKit 的 `useCrudModal` 管理弹窗状态
- 使用 CrudKit 的 `CrudFormModal` 封装表单弹窗
- 使用 CrudKit 的 `OperationColumn` 渲染操作列
- 使用 TDesign 的 `Tree` 组件实现部门树

### 7.5 权限控制实现

```typescript
// 在组件中获取用户角色
import { useUserStore } from 'stores/auth';

const DepartmentManager: React.FC = () => {
  const { user } = useUserStore();
  const isSuperAdmin = user?.roles?.includes('SUPER_ADMIN');
  const isDeptLeader = user?.roles?.includes('DEPARTMENT_LEADER');
  
  // 根据角色控制按钮显隐
  const canCreateDept = isSuperAdmin || (isDeptLeader && isFirstLevelLeader);
  const canEditDept = isSuperAdmin || isDeptLeader;
  // ...
};
```

---

## 8. 成功指标

1. 部门树加载性能 < 200ms
2. 成员列表分页查询性能 < 100ms
3. 所有操作有明确的成功/失败反馈
4. 权限控制准确，无越权操作入口
5. 代码通过 `pnpm build` 编译检查
6. 代码通过 `pnpm lint` 检查

---

## 9. 待确认问题

1. ~~左侧部门树是否需要拖拽调整宽度？~~ **已确认：支持**
2. ~~成员管理是否需要独立页面？~~ **已确认：需要，作为补充入口**
3. ~~添加已有成员的范围如何界定？~~ **已确认：当前用户管辖范围内的成员**

