# PRD: 云仓库存管理与采购订单管理模块

## 1. Introduction/Overview

云仓库存管理与采购订单管理模块是仓储服务系统的核心功能之一，用于管理云仓库存信息、库存池配置和采购订单流程。该模块提供云仓库存的查询、库存池关联配置、采购订单的完整生命周期管理（创建、查询、编辑、确认），以及部门确认后自动增加库存的功能。

**目标**：为系统提供完整的云仓库存管理功能，支持多 SKU 共用库存池的灵活配置，并通过采购订单流程实现库存的规范化管理。

## 2. Goals

1. 提供云仓库存信息的查询功能，支持与京仓库存一致的筛选条件
2. 提供库存池管理功能，允许用户配置 SKU 之间的库存关联性（共用或独立）
3. 提供采购订单的完整 CRUD 操作（创建、查询、编辑）
4. 提供采购订单的部门确认和财务确认功能
5. 实现部门确认后自动为云仓库存池增加库存的逻辑
6. 支持采购订单和云仓库存的导出功能
7. 记录采购订单相关操作到商品变动日志

## 3. User Stories

1. **作为仓库管理员**，我希望能够查询云仓库存信息列表，以便了解所有商品的云仓库存情况
2. **作为仓库管理员**，我希望能够根据部门、SKU、负责人等条件筛选云仓库存，以便快速找到目标商品
3. **作为仓库管理员**，我希望能够查看商品的库存池信息，以便了解哪些 SKU 共用同一个库存池
4. **作为仓库管理员**，我希望能够配置多个 SKU 共用同一个库存池，以便实现库存共享
5. **作为仓库管理员**，我希望能够将共用库存池的 SKU 拆分为独立库存，以便实现库存分离
6. **作为采购人员**，我希望能够创建采购订单并添加采购详情，以便记录采购信息
7. **作为采购人员**，我希望能够查询和编辑采购订单，以便管理采购流程
8. **作为部门负责人**，我希望能够确认采购订单，以便触发库存增加流程
9. **作为财务人员**，我希望能够确认采购订单的财务状态，以便标记财务处理完成
10. **作为系统用户**，我希望能够导出采购订单和云仓库存信息，以便进行数据分析

## 4. Functional Requirements

### 4.1 云仓库存查询

1. **FR-1.1**: 系统必须提供分页查询云仓库存信息列表的接口
2. **FR-1.2**: 查询接口必须支持以下筛选条件（与京仓库存查询一致）：
   - 部门 ID (departmentId)
   - SKU 关键词 (skuKeyword)
   - 负责人 (responsiblePerson)
   - 店铺名称 (shopName)
   - 是否达到补货预警 (isLowStock)
   - 是否滞销产品 (isSluggish)
3. **FR-1.3**: 查询结果必须显示商品关联的库存池的实际数量（如果商品关联了库存池，显示库存池的 quantity；如果商品没有关联库存池，显示 0 或独立库存数量）
4. **FR-1.4**: 查询结果必须包含商品的基本信息（部门名称、店铺名称、SKU、负责人等）
5. **FR-1.5**: 查询结果必须包含云仓库存信息（日销量、月销量、补货预警阈值、滞销天数等）
6. **FR-1.6**: 查询接口必须进行权限校验（参考京仓库存的权限控制逻辑）
7. **FR-1.7**: 查询结果必须按创建时间倒序排列

### 4.2 云仓库存统计

1. **FR-2.1**: 系统必须提供云仓库存统计接口
2. **FR-2.2**: 统计接口必须支持与查询接口相同的筛选条件
3. **FR-2.3**: 统计结果必须包含总库存数量、总日销量、总月销量等汇总信息

### 4.3 设置补货预警阈值

1. **FR-3.1**: 系统必须提供设置云仓库存补货预警阈值的接口
2. **FR-3.2**: 设置接口必须校验商品是否存在云仓库存信息
3. **FR-3.3**: 设置操作必须进行权限校验

### 4.4 库存池信息查询

1. **FR-4.1**: 系统必须提供查询商品库存池信息的接口
2. **FR-4.2**: 查询接口必须支持单个商品 ID 查询
3. **FR-4.3**: 查询结果必须包含以下信息：
   - 商品基本信息（ID、SKU、部门名称等）
   - 当前关联的库存池 ID（如果存在）
   - 库存池的实际数量
   - 共用该库存池的其他商品列表（商品 ID、SKU、部门名称等）
   - 是否独立库存（yunCangInventoryPoolId 为 null 表示独立库存）
4. **FR-4.4**: 如果商品没有关联库存池，返回信息中应明确标识为独立库存

### 4.5 库存池关联配置

1. **FR-5.1**: 系统必须提供配置库存池关联关系的接口
2. **FR-5.2**: 配置接口必须支持以下操作：
   - **设置共用库存池**：将多个商品设置为共用同一个库存池
     - 如果目标商品都没有库存池，创建新的库存池并关联这些商品
     - 如果目标商品中部分已有库存池，将这些商品合并到指定的库存池（需要指定目标库存池 ID）
     - 如果目标商品都有不同的库存池，需要先合并库存池（将多个库存池的数量累加），然后关联所有商品到合并后的库存池
   - **设置独立库存**：将商品从共用库存池中拆分出来，创建独立库存池
     - 如果商品当前关联了库存池，创建新的独立库存池，数量从原库存池中分配（需要指定分配数量，默认分配当前库存池的全部数量）
     - 如果商品已经是独立库存，无需操作
3. **FR-5.3**: 配置操作必须进行权限校验（用户必须对涉及的所有商品有管理权限）
4. **FR-5.4**: 配置操作必须校验商品是否存在
5. **FR-5.5**: 当多个商品共用库存池时，如果原库存池有库存数量，合并时需要累加所有库存池的数量
6. **FR-5.6**: 拆分独立库存时，如果原库存池还有其他商品在使用，需要从原库存池中减去分配的数量

### 4.6 云仓库存导出

1. **FR-6.1**: 系统必须提供导出云仓库存信息的接口
2. **FR-6.2**: 导出接口必须支持与查询接口相同的筛选条件
3. **FR-6.3**: 导出格式必须为 Excel 文件
4. **FR-6.4**: 导出数据必须包含商品基本信息和云仓库存信息

### 4.7 采购订单创建

1. **FR-7.1**: 系统必须提供创建采购订单的接口
2. **FR-7.2**: 创建接口必须要求用户输入采购批次号（purchaseBatchNumber），且批次号必须唯一
3. **FR-7.3**: 创建接口必须要求至少包含一个采购详情（purchaseDetails）
4. **FR-7.4**: 每个采购详情必须包含以下信息：
   - 商品 ID (goodId)
   - 采购数量 (quantity)
   - 采购金额 (purchaseAmount)
   - 采购订单号 (purchaseOrderNumber，可选)
   - 快递单号 (expressNo，可选)
5. **FR-7.5**: 创建操作必须进行权限校验（用户必须对采购详情中的所有商品有管理权限，参考商品查询的权限控制逻辑）
6. **FR-7.6**: 创建操作必须校验商品是否存在
7. **FR-7.7**: 创建操作必须校验采购批次号是否已存在

### 4.8 采购订单查询

1. **FR-8.1**: 系统必须提供分页查询采购订单列表的接口
2. **FR-8.2**: 查询接口必须支持以下筛选条件：
   - 采购批次号 (purchaseBatchNumber)
   - 部门 ID (departmentId，通过采购详情中的商品关联查询)
   - 部门确认状态 (departmentConfirmStatus)
   - 财务确认状态 (financeConfirmStatus)
   - 创建时间范围 (createdAtStart, createdAtEnd)
3. **FR-8.3**: 查询结果必须包含采购订单的所有字段
4. **FR-8.4**: 查询结果必须包含关联的采购详情列表，每个详情包含商品信息
5. **FR-8.5**: 查询接口必须进行权限校验（用户只能查询有权限管理的商品相关的采购订单）
6. **FR-8.6**: 查询结果必须按创建时间倒序排列

### 4.9 采购订单编辑

1. **FR-9.1**: 系统必须提供编辑采购订单的接口
2. **FR-9.2**: 编辑接口必须支持修改采购批次号（如果修改，需要校验新批次号是否已存在）
3. **FR-9.3**: 编辑接口必须支持修改、添加、删除采购详情
4. **FR-9.4**: 如果采购订单已部门确认（departmentConfirmStatus 为 true），禁止编辑采购详情（purchaseDetails），但允许修改其他字段（如批次号）
5. **FR-9.5**: 财务确认状态不影响编辑权限
6. **FR-9.6**: 编辑操作必须进行权限校验（用户必须对涉及的所有商品有管理权限）
7. **FR-9.7**: 编辑操作必须校验商品是否存在

### 4.10 采购订单部门确认

1. **FR-10.1**: 系统必须提供部门确认采购订单的接口
2. **FR-10.2**: 部门确认接口必须将 departmentConfirmStatus 设置为 true
3. **FR-10.3**: 部门确认后，必须遍历采购订单的所有采购详情，为每个商品增加云仓库存：
   - 如果商品已有云仓库存信息（YunCangStockInfo），获取其关联的库存池
   - 如果商品没有云仓库存信息，创建 YunCangStockInfo 记录（日销量、月销量初始化为 0，补货预警阈值使用默认值 10）
   - 如果商品没有关联库存池，创建新的独立库存池，数量为 0
   - 将采购数量累加到商品的库存池中（如果多个商品共用同一个库存池，累加到共享库存池）
4. **FR-10.4**: 部门确认操作必须进行权限校验（用户必须对采购订单中的所有商品有管理权限）
5. **FR-10.5**: 部门确认操作必须记录变动日志到商品变动日志（GoodChangeLog），记录内容包含采购批次号、采购数量等信息
6. **FR-10.6**: 如果库存增加过程中出现错误，必须回滚部门确认状态，并返回错误信息
7. **FR-10.7**: 部门确认操作必须校验采购订单是否存在且未确认

### 4.11 采购订单财务确认

1. **FR-11.1**: 系统必须提供财务确认采购订单的接口
2. **FR-11.2**: 财务确认接口必须将 financeConfirmStatus 设置为 true
3. **FR-11.3**: 财务确认必须在部门确认之后（如果 departmentConfirmStatus 为 false，不允许进行财务确认）
4. **FR-11.4**: 财务确认仅作为状态标记，不触发任何业务逻辑
5. **FR-11.5**: 财务确认操作必须校验采购订单是否存在且已部门确认

### 4.12 采购订单导出

1. **FR-12.1**: 系统必须提供导出采购订单的接口
2. **FR-12.2**: 导出接口必须支持与查询接口相同的筛选条件
3. **FR-12.3**: 导出格式必须为 Excel 文件
4. **FR-12.4**: 导出数据必须扁平化采购详情（每个采购详情作为一行，包含采购订单信息和采购详情信息）

## 5. Non-Goals (Out of Scope)

1. 云仓库存信息的导入功能（云仓库存记录数量由商品信息数量决定，有多少个商品就有多少个云仓库存记录）
2. 采购订单的导入功能（必须通过创建接口进行交互）
3. 采购订单的删除功能（不在本次需求范围内）
4. 库存池的删除功能（库存池通过关联关系自动管理）
5. 采购订单的撤销确认功能（不在本次需求范围内）
6. 库存池数量的手动调整功能（库存数量只能通过采购订单部门确认来增加）

## 6. Design Considerations

### 6.1 库存池管理交互设计

**查询库存池信息接口**：

- 接口路径：`POST /sys-stock/get-yun-cang-inventory-pool-info`
- 请求参数：`{ goodId: string }`
- 返回数据：包含商品信息、库存池信息、共用商品列表

**配置库存池关联接口**：

- 接口路径：`POST /sys-stock/configure-inventory-pool`
- 请求参数设计：
  ```typescript
  {
    operation: 'merge' | 'split',  // merge: 设置共用库存池, split: 设置独立库存
    goodIds: string[],              // 涉及的商品ID列表
    targetPoolId?: string,          // 目标库存池ID（merge操作时，如果指定则合并到该库存池）
    splitQuantity?: number          // 拆分数量（split操作时，从原库存池分配的数量）
  }
  ```

### 6.2 采购订单数据结构

采购订单查询结果应包含完整的采购详情信息，每个详情包含关联的商品完整信息，便于前端展示。

## 7. Technical Considerations

### 7.1 权限控制

1. **云仓库存权限**：参考京仓库存的权限控制逻辑（handleJingCangStockAbility），需要添加对应的 YunCangStockInfo 权限处理函数
2. **采购订单权限**：参考商品管理的权限控制逻辑（handleGoodsAbility），用户只能操作有权限管理的商品相关的采购订单
3. **库存池配置权限**：用户必须对涉及的所有商品有管理权限

### 7.2 数据库事务

1. **部门确认操作**：必须使用数据库事务，确保库存增加和确认状态更新的原子性
2. **库存池配置操作**：必须使用数据库事务，确保库存池创建、关联关系更新、数量分配的原子性

### 7.3 库存池数量计算

1. 查询云仓库存时，如果商品关联了库存池，显示库存池的 quantity 字段
2. 如果商品没有关联库存池（yunCangInventoryPoolId 为 null），表示独立库存，此时需要查询是否有独立的库存池，如果没有则显示 0

### 7.4 变动日志记录

1. 部门确认采购订单时，需要为每个采购详情中的商品记录变动日志
2. 变动日志内容格式：`"采购订单[批次号]确认，增加库存[数量]"`
3. 变动日志必须包含操作人信息（userId, username）

### 7.5 错误处理

1. 部门确认时，如果库存增加失败，必须回滚确认状态
2. 库存池配置时，如果操作失败，必须回滚所有数据库变更
3. 所有接口必须返回明确的错误信息

## 8. Success Metrics

1. 用户能够成功查询云仓库存信息，查询性能与京仓库存查询相当
2. 用户能够成功配置库存池关联关系，操作响应时间在 2 秒以内
3. 用户能够成功创建和编辑采购订单，操作成功率 100%
4. 部门确认后，库存增加操作成功率 100%，且数据一致性得到保证
5. 所有操作都有完整的权限控制和日志记录

## 9. Open Questions

1. **库存池拆分时的数量分配策略**：当从共用库存池拆分出独立库存时，如何确定分配数量？是否需要用户指定，还是默认分配全部数量？
   - 当前设计：需要用户指定 splitQuantity 参数，如果未指定则分配全部数量
2. **库存池合并时的数量处理**：当多个商品合并到同一个库存池时，如果这些商品原本有独立的库存池，是否需要累加所有库存池的数量？
   - 当前设计：需要累加所有库存池的数量
3. **云仓库存的初始创建时机**：云仓库存信息（YunCangStockInfo）应该在什么时候创建？是在商品创建时自动创建，还是在首次需要时创建？
   - 当前设计：在部门确认采购订单时，如果商品没有云仓库存信息则自动创建
4. **采购订单的删除功能**：是否需要支持删除采购订单？如果删除，是否需要回滚已确认的库存增加？
   - 当前设计：不在本次需求范围内
