# 商品管理功能需求文档 (PRD)

## 1. 概述 (Introduction/Overview)

商品管理是仓储服务系统的核心业务功能，用于管理各部门的商品信息。本功能需要在 `frontend/src/pages/Business/GoodsManager/index.tsx` 中实现，充分利用现有的 CrudKit 组件库，提供商品的查询、编辑、删除、额外成本管理及批量导入等完整功能。

**核心问题**：系统需要一个统一的界面来管理商品信息，支持按部门筛选、多维度搜索，并能处理商品的各类成本数据和额外成本项目。

## 2. 目标 (Goals)

1. 提供商品列表的查询和过滤功能，支持按部门、店铺名称、SKU、货架号、入仓条码等条件筛选
2. 实现商品全字段的编辑功能
3. 支持删除指定商品
4. 提供额外成本的查看、添加、删除功能
5. 实现 Excel 文件导入商品功能
6. 根据用户角色智能处理部门筛选选项

## 3. 用户故事 (User Stories)

### US-1: 商品列表查询
**作为**仓储管理人员，**我想要**查看和筛选商品列表，**以便**快速找到需要的商品信息。

### US-2: 编辑商品信息
**作为**部门负责人，**我想要**修改商品的各项信息，**以便**保持商品数据的准确性。

### US-3: 删除商品
**作为**部门负责人，**我想要**删除不再需要的商品记录，**以便**保持数据整洁。

### US-4: 管理额外成本
**作为**部门负责人，**我想要**查看和管理商品的额外成本项目，**以便**精确计算商品的总成本。

### US-5: 批量导入商品
**作为**管理人员，**我想要**通过 Excel 文件批量导入商品，**以便**快速录入大量商品数据。

### US-6: 部门数据隔离
**作为**二级部门普通成员，**我只能**查看本部门的商品数据，**以确保**数据安全和权限控制。

## 4. 功能需求 (Functional Requirements)

### 4.1 商品列表查询

| 编号 | 需求描述 |
|------|---------|
| FR-1.1 | 系统必须提供分页的商品列表展示 |
| FR-1.2 | 列表需展示所有商品字段，支持横向滚动查看 |
| FR-1.3 | SKU 字段（数组类型）需支持点击展开查看全部 |
| FR-1.4 | 产品图片需在列表中显示缩略图，点击可放大查看 |
| FR-1.5 | 系统必须支持按部门ID、店铺名称、SKU关键词、货架号、入仓条码进行筛选 |

### 4.2 部门筛选权限控制

| 编号 | 需求描述 |
|------|---------|
| FR-2.1 | 一级部门负责人：可以看到并筛选所有管辖的部门（一级部门 + 下属二级部门） |
| FR-2.2 | 二级部门负责人：可以看到并筛选其负责的二级部门 |
| FR-2.3 | 二级部门普通成员：**不显示部门筛选选项**，自动锁定为其所属部门 |
| FR-2.4 | 部门筛选需调用 `/sys-dept/tree` API 获取部门树数据 |

### 4.3 商品编辑

| 编号 | 需求描述 |
|------|---------|
| FR-3.1 | 系统必须支持编辑商品的所有可修改字段 |
| FR-3.2 | 编辑表单需分组展示字段（基本信息、成本信息、比例设置） |
| FR-3.3 | 数值类型字段需进行格式校验（非负数） |
| FR-3.4 | 比例字段需限制输入范围 0-100（百分比格式） |

**可编辑字段清单：**
- 基本信息：部门ID、店铺名称、SKU（数组）、货架号、产品图片URL、入仓条码、产品规格、合格证图URL
- 成本信息：进货成本、最低售价、快递费用、耗材费、销售出库费、TC到仓费、人工打包费
- 比例设置：交易服务费比例、佣金比例、平台推广比例、货损比例

### 4.4 商品删除

| 编号 | 需求描述 |
|------|---------|
| FR-4.1 | 系统必须支持删除单个商品 |
| FR-4.2 | 删除操作需二次确认 |
| FR-4.3 | 删除成功后自动刷新列表 |

### 4.5 额外成本管理

| 编号 | 需求描述 |
|------|---------|
| FR-5.1 | 在商品操作列提供"额外成本"按钮，点击弹出详情弹窗 |
| FR-5.2 | 弹窗中展示该商品的所有额外成本项目列表（金额、描述、创建时间） |
| FR-5.3 | 弹窗中支持添加新的额外成本项目（输入金额和描述） |
| FR-5.4 | 弹窗中支持删除已有的额外成本项目，需二次确认 |
| FR-5.5 | 额外成本列表需展示总金额汇总 |

### 4.6 商品导入

| 编号 | 需求描述 |
|------|---------|
| FR-6.1 | 系统必须支持通过 Excel 文件（xlsx、xls 格式）导入商品 |
| FR-6.2 | 使用 `browser-fs-access` 库的 `fileOpen` API 进行文件选择 |
| FR-6.3 | 导入完成后弹出详细结果弹窗，展示成功数量、失败数量及错误信息列表 |
| FR-6.4 | 导入成功后自动刷新商品列表 |
| FR-6.5 | 工具栏提供"下载模板"按钮，点击下载导入模板文件 |
| FR-6.6 | 模板文件路径：`/template/商品信息导入模板.xlsx`（静态资源） |

## 5. 非目标 (Non-Goals / Out of Scope)

1. **商品变动日志**：本需求不包含商品变动日志的展示，将在独立页面实现
2. **商品新增**：商品仅通过导入方式创建，不提供手动新增单个商品的功能
3. **批量删除**：本期不实现批量删除功能
4. **导出功能**：本期不实现商品数据导出功能
5. **图片上传**：图片字段仅支持填写 URL，不支持上传

## 6. 设计考量 (Design Considerations)

### 6.1 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  搜索区域 (CrudSearchForm)                                    │
│  [部门选择*] [店铺名称] [SKU关键词] [货架号] [入仓条码] [搜索] [重置] │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│  工具栏 (CrudToolbar)                                        │
│  [下载模板] [导入商品]                                         │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│  商品表格 (Table) - 支持横向滚动                               │
│  ┌───────┬────────┬─────┬──────┬────────┬─────┬──────────┐  │
│  │ 图片  │ 店铺名 │ SKU │ 货架号│ 入仓条码│ ... │ 操作     │  │
│  ├───────┼────────┼─────┼──────┼────────┼─────┼──────────┤  │
│  │ [img] │ xxx    │ ... │ A-01 │ BC001  │ ... │编辑│删除│成本│  │
│  └───────┴────────┴─────┴──────┴────────┴─────┴──────────┘  │
└─────────────────────────────────────────────────────────────┘

* 部门选择仅对一级/二级部门负责人显示，普通成员不显示此筛选项
```

### 6.2 组件使用规划

| 功能模块 | 使用组件 |
|---------|---------|
| 页面整体 | 可考虑使用 `CrudPage` 或组合使用底层组件 |
| 搜索表单 | `CrudSearchForm` |
| 工具栏 | `CrudToolbar` |
| 表格 | TDesign `Table` (需要自定义列渲染) |
| 操作列 | `OperationColumn` |
| 编辑弹窗 | `CrudFormModal` |
| 额外成本弹窗 | 自定义 `Dialog` 组件 |
| 导入结果弹窗 | 自定义 `Dialog` 组件 |

### 6.3 表格列配置建议

**固定列（左侧）：**
- 产品图片（缩略图）
- 店铺名称
- SKU（可展开）

**滚动区域：**
- 部门名称
- 货架号
- 入仓条码
- 产品规格
- 进货成本
- 最低售价
- 快递费用
- 耗材费
- 销售出库费
- TC到仓费
- 人工打包费
- 交易服务费比例
- 佣金比例
- 平台推广比例
- 货损比例
- 创建时间
- 更新时间

**固定列（右侧）：**
- 操作列（编辑、删除、额外成本）

## 7. 技术考量 (Technical Considerations)

### 7.1 API 依赖

| 功能 | API | 方法 |
|-----|-----|------|
| 获取商品列表 | `sysGoodsControllerGetGoodsList` | POST |
| 修改商品 | `sysGoodsControllerUpdateGoods` | POST |
| 删除商品 | `sysGoodsControllerDeleteGoods` | DELETE |
| 添加额外成本 | `sysGoodsControllerAddExtraCost` | POST |
| 删除额外成本 | `sysGoodsControllerDeleteExtraCost` | DELETE |
| 导入商品 | `sysGoodsControllerImportGoods` | POST (multipart/form-data) |
| 获取部门树 | `sysDeptControllerGetDeptTree` | GET |

### 7.2 类型定义

```typescript
// 主要使用的类型（来自 services/generated/model）
import type { 
  GoodsEntity,
  GoodsQueryDto,
  UpdateGoodsDto,
  AddExtraCostDto,
  ExtraCostEntity,
  DeptTreeEntity 
} from 'services/generated/model';
```

### 7.3 文件导入实现

```typescript
import { fileOpen } from 'browser-fs-access';

// 文件选择配置
const file = await fileOpen({
  mimeTypes: [
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // xlsx
    'application/vnd.ms-excel' // xls
  ],
  extensions: ['.xlsx', '.xls'],
  description: 'Excel 文件',
});
```

### 7.4 模板下载实现

```typescript
// 模板文件为静态资源，直接通过 a 标签下载
const handleDownloadTemplate = () => {
  const link = document.createElement('a');
  link.href = '/template/商品信息导入模板.xlsx';
  link.download = '商品信息导入模板.xlsx';
  link.click();
};
```

### 7.5 部门筛选权限判断

需要根据当前用户信息判断其角色类型：
- 通过 `useAuthStore` 获取用户权限信息
- 通过部门树接口返回的数据结构判断用户可访问的部门范围
- 普通成员（无 leadingDepartments）不渲染部门筛选组件

### 7.6 图片预览

推荐使用 TDesign 的 `Image` 组件或 `ImageViewer` 组件实现缩略图展示和点击放大功能。

## 8. 成功指标 (Success Metrics)

1. 商品列表能够正确展示所有字段，支持横向滚动
2. 搜索筛选功能正常工作，结果准确
3. 部门筛选根据用户角色正确显示/隐藏
4. 商品编辑功能覆盖所有可编辑字段，数据保存成功
5. 商品删除功能正常工作，有确认提示
6. 额外成本的增删查功能完整可用
7. Excel 导入功能正常工作，结果展示清晰
8. 页面无明显卡顿，大数据量下性能可接受

## 9. 开放问题 (Open Questions)

1. ~~商品图片是否需要支持上传功能？~~ **已确认：仅支持 URL 填写**
2. ~~是否需要商品变动日志入口？~~ **已确认：单独页面实现**
3. ~~比例字段的具体范围是 0-100（百分比）还是 0-1（小数）？~~ **已确认：0-100 百分比**
4. ~~导入模板是否需要提供下载链接？~~ **已确认：提供下载按钮，路径 `/template/商品信息导入模板.xlsx`**

---

**文档版本**: v1.0  
**创建日期**: 2025-12-03  
**状态**: 待评审

